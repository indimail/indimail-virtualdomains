#!/bin/sh
# postrm script for indimail
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <postrm> `remove'
#        * <postrm> `purge'
#        * <old-postrm> `upgrade' <new-version>
#        * <new-postrm> `failed-upgrade' <old-version>
#        * <new-postrm> `abort-install'
#        * <new-postrm> `abort-install' <old-version>
#        * <new-postrm> `abort-upgrade' <old-version>
#        * <disappearer's-postrm> `disappear' <overwriter>
#          <overwriter-version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package


prefix=@prefix@
mandir=@mandir@
indimaildir=@indimaildir@
libexecdir=@libexecdir@
sysconfdir=@sysconfdir@
servicedir=@servicedir@
default_domain=@defaultDomain@
logdir=@logdir@
rm=/bin/rm
rmdir=/bin/rmdir
mv=/bin/mv
build_on_obs=0
####################################
noproxy=0

ID=`id -u`
if [ $ID -ne 0 ] ; then
	echo "You are not root" >&2
	exit 1
fi

case "$1" in
    purge|remove|upgrade|failed-upgrade|abort-install|abort-upgrade|disappear)
	if [ -f ${libexecdir}/iupgrade.sh ] ; then
	(
		echo "Running Custom Upgrade Script for pre $1"
		/bin/sh ${libexecdir}/iupgrade.sh postrm $1 @version@ $* || true
	) >> /var/log/indimail-setup.log 2>&1
	fi
    ;;

    *)
        echo "postrm called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

# we are doing upgrade or removal
if [ " $1" = " upgrade" ] ; then
	if [ ! "${prefix}" = "/usr" ] ; then
	echo "recreating ld.so cache"
	/sbin/ldconfig
	fi
	exit 0
fi

case "$1" in
    failed-upgrade|abort-install|abort-upgrade|disappear)
	exit 0
    ;;
esac
if [ $build_on_obs -eq 0 ] ; then
	if [ -x /usr/bin/uname -o -x /bin/uname ] ; then
		default_domain=$(echo $([ -n "$HOSTNAME" ] && echo "$HOSTNAME" || uname -n) | sed 's/^\([^\.]*\)\.\([^\.]*\)\./\2\./')
	else
		default_domain=$([ -n "$HOSTNAME" ] && echo "$HOSTNAME" | sed 's/^\([^\.]*\)\.\([^\.]*\)\./\2\./' || echo ${default_domain})
	fi
fi
#
# Debian silliness
#
(
if [ " $1" = " purge" ] ; then
	echo "removing database and configuration"
	${rm} -rf ${indimaildir}/mysqldb || true
	if [ -f /etc/mysql/indimail.cnf ] ; then
		${rm} -f /etc/mysql/indimail.cnf
	fi
	# remove all virtual domains
	for i in `ls ${indimaildir}/domains`
	do
		grep -wv "^+$i-" ${sysconfdir}/users/assign > ${sysconfdir}/assign.tmp
		${mv} ${sysconfdir}/assign.tmp ${sysconfdir}/users/assign
	done
	if [ -x ${prefix}/sbin/qmail-newu ] ; then
		${prefix}/sbin/qmail-newu
	fi
fi

for i in .qmail-nonspam .qmail-register-nonspam .qmail-register-spam .qmail-spam
do
	${rm} -f ${indimaildir}/domains/${default_domain}/$i
done

for port in 465 25 587
do
	> ${servicedir}/qmail-smtpd.$port/variables/VIRTUAL_PKG_LIB
done
${rm} -f ${sysconfdir}/indimail.mrtg.ok ${sysconfdir}/system.mrtg.ok
echo "removing startup services"

if [ $noproxy -eq 0 ] ; then
for i in proxy-imapd.4143 proxy-imapd-ssl.9143 \
proxy-pop3d.4110 proxy-pop3d-ssl.9110
do
	if [ -d ${servicedir}/$i -o -L ${servicedir}/$i ] ; then
		touch ${servicedir}/$i/down
		svc -dx ${servicedir}/$i >/dev/null 2>&1 || true
	fi
	if [ -d ${servicedir}/$i/log -o -L ${servicedir}/$i/log ] ; then
		touch ${servicedir}/$i/log/down || true
		svc -dx ${servicedir}/$i/log >/dev/null 2>&1 || true
	fi
	if [ -d ${servicedir}/$i -o -L ${servicedir}/$i ] ; then
		${rm} -rf ${servicedir}/$i || true
 	fi
done
fi

for i in indisrvr.4000 inlookup.infifo mysql.3306 \
qmail-poppass.106 mrtg qmail-logfifo
do
	if [ -d ${servicedir}/$i -o -L ${servicedir}/$i ] ; then
		touch ${servicedir}/$i/down
		svc -dx ${servicedir}/$i >/dev/null 2>&1 || true
	fi
	if [ -d ${servicedir}/log/$i -o -L ${servicedir}/log/$i ] ; then
		touch ${servicedir}/$i/log/down
		svc -dx ${servicedir}/$i/log >/dev/null 2>&1 || true
	fi
	if [ -d ${servicedir}/$i -o -L ${servicedir}/$i/log ] ; then
		${rm} -rf ${servicedir}/$i || true
	fi
done

count=`/bin/ls ${servicedir} 2>/dev/null| /usr/bin/wc -l`
if [ $count -eq 0 ] ; then # ignore disabled services
	${rm} -rf ${servicedir} || true
fi

if [ -d /etc/cron.d ] ; then
	echo "removing cron entries"
	${rm} -f /etc/cron.d/indimail.cron.d
fi

echo "removing TCP configuration"
${rm} -f ${sysconfdir}/tcp/tcp.poppass.cdb ${sysconfdir}/tcp/tcp.poppass
${rm} -f ${sysconfdir}/control/controlfiles
for i in indimail.cnf indimail-stat.override backup.conf headerlist \
	indimail.mrtg.cfg procmailrc indimail.settings osh.table perm_list.indimail \
	qmailprog.list services.log
do
	${rm} -f ${sysconfdir}/$i
done

echo "removing logs"
${rm} -f ${indimaildir}/mysqldb/logs/logisam.log
${rm} -f ${indimaildir}/mysqldb/logs/logquery
${rm} -f ${indimaildir}/mysqldb/logs/logslow

if [ -h ${logdir} ] ; then
	log_dir=`/bin/ls -ld ${logdir} | /usr/bin/awk '{print $10}'`
else
	log_dir=${logdir}
fi

if [ $noproxy -eq 0 ] ; then
for i in proxyIMAP.4143 proxyIMAP.9143 \
proxyPOP3.4110 proxyPOP3.9110
do
	${rm} -rf $log_dir/$i
done
fi

for i in indisrvr.4000 inlookup.infifo \
mrtg mysql.3306 poppass.106 logfifo
do
	${rm} -rf $log_dir/$i
done

if [ ! "${prefix}" = "/usr" ] ; then
	echo "recreating ld.so cache"
	/sbin/ldconfig
fi
) >> /var/log/indimail-setup.log
exit 0
